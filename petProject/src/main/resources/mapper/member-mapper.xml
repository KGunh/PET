<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberMapper">

	<resultMap type="animal" id="animalResultSet">
		<result column="ANIMAL_NAME" property="animalName"/>
		<result column="ANIMAL_CODE" property="animalCode"/>
	    <result column="MEMBER_NO" property="memberNo"/>
	</resultMap>

	<resultMap type="coupon" id="couponResultSet">
		<result column="COUPON_NO" property="couponNo"/>
		<result column="COUPON_NAME" property="couponName"/>
		<result column="CREATE_DATE" property="createDate"/>
		<result column="END_DATE" property="endDate"/>
		<result column="DISCOUNT_RATE" property="discountRate"/>
		<result column="COUPON_STATUS" property="couponStatus"/>
	</resultMap>
	
	<resultMap type="memberCoupon" id="memberCouponResultSet">
		<result column="ISSUE_DATE" property="issueDate"/>
		<result column="COUPON_NO" property="couponNo"/>
		<result column="MEMBER_COUPON_STATUS" property="memberCouponStatus"/>
		<collection resultMap="couponResultSet" property="coupon"/>	
	</resultMap>
	
	<resultMap type="member" id="memberResultSet">
		<result column="MEMBER_NO" property="memberNo"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="MEMBER_PWD" property="memberPwd"/>
		<result column="MEMBER_NAME" property="memberName"/>
		<result column="EMAIL" property="email"/>
		<result column="NICKNAME" property="nickname"/>
		<result column="PHONE" property="phone"/>
		<result column="MEMBER_STATUS" property="memberStatus"/>
		<result column="ANIMAL_NAME" property="animalName"/>
		<result column="ANIMAL_CODE" property="animalCode"/>
		<collection resultMap="memberCouponResultSet" property="couponList"/>
	</resultMap>
	
	<select id="idCheck" parameterType="string" resultType="_int">
		SELECT
				COUNT(*)
		  FROM
		  		TB_MEMBER
		 WHERE
		 		MEMBER_ID = #{checkId} 						
	</select>
	
	<select id="checkNick" parameterType="string" resultType="_int">
		SELECT
				COUNT(*)
		  FROM
		  		TB_MEMBER
		 WHERE
		 		NICKNAME = #{nickname} 						
	</select>
	
	<select id="checkPhone" parameterType="string" resultType="_int">
		SELECT
				COUNT(*)
		  FROM
		  		TB_MEMBER
		 WHERE
		 		PHONE = #{phone} 						
	</select>
	
	<select id="checkEmail" parameterType="string" resultType="_int">
		SELECT
				COUNT(*)
		  FROM
		  		TB_MEMBER
		 WHERE
		 		EMAIL = #{email} 						
	</select>
	
	<select id="login" parameterType="member" resultMap="memberResultSet">
		SELECT
		       MEMBER_NO,
		       MEMBER_ID,
		       MEMBER_PWD,
		       MEMBER_NAME,
		       EMAIL,
		       NICKNAME,
		       PHONE,
		       MEMBER_STATUS,
		       TO_CHAR(ENROLL_DATE , 'YYYY/MM/DD') AS ENROLL_DATE, 
    		   TO_CHAR(MODIFY_DATE , 'YYYY/MM/DD') AS MODIFY_DATE
		  FROM
		       TB_MEMBER
		 WHERE
		       MEMBER_ID = #{memberId}
		   AND
		       MEMBER_STATUS != 'D'
	</select>

	<insert id="join" parameterType="member">
		INSERT
		  INTO
		  		TB_MEMBER
		VALUES
				(
				SEQ_MEMNO.NEXTVAL,
				#{memberId},
				#{memberPwd},
				#{memberName},
				#{email},
				#{nickname},
				#{phone},
				#{memberStatus},
				SYSDATE,
				SYSDATE
				)
	</insert>
	
	<select id="searchId" parameterType="member" resultType="string">
		SELECT
		        MEMBER_ID
		  FROM 
		        TB_MEMBER
		 WHERE
		        MEMBER_NAME = #{memberName}
		   AND
		        EMAIL = #{email}
		   AND
		   	 	MEMBER_STATUS = 'C'
	</select>
	
	<select id="searchPwd" parameterType="member" resultType="_int" >
		SELECT
		        MEMBER_NO
		  FROM 
		        TB_MEMBER
		 WHERE
		        MEMBER_ID = #{memberId}
		   AND
		        EMAIL = #{email}
		   AND
		   	 	MEMBER_STATUS = 'C'
	</select>
	
	<update id="updatePwd" parameterType="member">
		UPDATE
				TB_MEMBER
		   SET
		   		MEMBER_PWD = #{memberPwd}
		 WHERE
		        MEMBER_NO = #{memberNo}
		   AND
		   	 	MEMBER_STATUS = 'C'
	</update>
	
	<select id="selectMember" resultType="_int" parameterType="string">
		SELECT
		       MEMBER_NO
		  FROM
		       TB_MEMBER
		 WHERE 
		 	   MEMBER_ID = #{memberId}
	</select>
	
	<insert id="insertAnimals" parameterType="animal">
	    INSERT INTO TB_MEMBER_ANIMAL
	    VALUES
	        (
	        #{memberNo},
	        #{animalCode}
	        )
	</insert>	
	
	
	<insert id="insertCode" parameterType="com.kh.pet.member.model.vo.CertVO">
		INSERT INTO TB_CERT VALUES (#{who}, #{secret}, SYSDATE)
	</insert>
	
	<select id="validate" parameterType="com.kh.pet.member.model.vo.CertVO" resultType="com.kh.pet.member.model.vo.CertVO">
		SELECT
				WHO,
				CODE,
				WHEN
	      FROM
	      		TB_CERT
	     WHERE
	     		WHO = #{who}
	       AND
	       		CODE = #{secret}
	       AND
	       		WHEN BETWEEN SYSDATE - 3/24/60 AND SYSDATE									
	</select>
	
	<delete id="deleteCert" parameterType="com.kh.pet.member.model.vo.CertVO">
		delete TB_CERT where who = #{who} and code = #{secret}
	</delete>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</mapper>